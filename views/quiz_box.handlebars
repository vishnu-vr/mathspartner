<div class="row">
    {{!-- free column --}}
    <div class="col-md-">
          
    </div>
    {{!-- free column --}}
    <div class="col-lg"> 
    <h1 id="heading" class="mt-4 text-center"></h1>
    {{!-- user details --}}
    <div class="row mt-4" id='user_details'>
        <div class="col-sm">
        </div>
        <div class="col-sm text-center">
            <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="basic-addon1">Name</span>
            </div>
            <input id='name_of_user' type="text" class="form-control" placeholder="Enter Your Name" aria-label="name" aria-describedby="basic-addon1">
            </div>
            <button id='start_quiz_btn' type="button" class="btn btn-primary" onclick="start_quiz()">Start Quiz</button>
        </div>
        <div class="col-sm">
        </div>
    </div>
    {{!-- quiz box --}}
    <div class="jumbotron mt-4 text-center" id='jumbotron' hidden>
    {{!-- <h1 class="display-4">Hello, world!</h1> --}}
    {{!-- question --}}
    <p class="text-right" id="timer">timer here</p>
    <p class="lead display-4" id="question">question comes here ?</p>
    <hr class="my-4">
    {{!-- list of answers --}}
    <ul class="list-group" id="answers_list">
        {{!-- <li class="list-group-item">Cras justo odio</li> --}}
    </ul>
    {{!-- list of answers --}}
    <button id="previous" class="btn btn-primary btn-lg mt-4" onclick="previous()" role="button">Previous</button>
    <button id="next" class="btn btn-primary btn-lg mt-4" onclick="next()" role="button">Next</button>
    <br>
    <button data-toggle="modal" data-target="#exampleModal" id="submit" class="btn btn-danger btn-lg mt-4" onclick="submit()" role="button">Submit</button>
    </div>
    {{!-- quiz box --}}
    </div>
    {{!-- free column --}}
    <div class="col-md-">
         
    </div>
    {{!-- free column --}}
</div>

<!-- Button trigger modal -->
{{!-- <button id="modal" type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
  Launch demo modal
</button> --}}

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Progress Card</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="location.reload()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div id="modal-body" class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="location.reload()">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
    // set the title
    document.getElementById('title').innerText = "{{title}}"
    
    // set the active link dynamically
    var nav_selected = document.getElementById('{{ nav_selected }}')
    nav_selected.className += ' active'

    // get the name of the quiz
    var heading = document.getElementById('heading').innerHTML = "{{heading}}" || "QUIZ"

    // get the questions and answers
    var questions = {{{json questions }}}

    // start quiz button
    function start_quiz(){
        if (mode == 'test'){
            // check whether the user has provided their name
            const name_of_user = document.getElementById('name_of_user')
            if (name_of_user.value == ''){
                alert('Please provide your name')
                return
            }
        }
        // disable the button
        document.getElementById('start_quiz_btn').disabled = true
        // make the jumbotron visible
        document.getElementById('jumbotron').hidden = false
        // start the timer
        startTimer(timeee,timer)
    }

    // timer
    var time_interval = null
    var current_time = 0
    const timer = document.getElementById('timer')
    function startTimer(duration, display) {
        var timer = duration, minutes, seconds;
        time_interval = setInterval(function () {
            minutes = parseInt(timer / 60, 10)
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + ":" + seconds;
            current_time = timer
            // console.log(current_time)
            if (--timer < 0) {
                timer = duration;
                alert("Sorry, times up!!!")
                document.getElementById('submit').click()
            }
        }, 1000);
    }
    // set the value as seconds * minutes * hours
    var timeee = {{ time }}
    {{!-- startTimer(timeee,timer) --}}

    // next and previous buttons
    const next_button = document.getElementById('next')
    const previous_button = document.getElementById('previous')

    // saving user selected options
    var user_selected_options = []
    // for (var i=0; i<questions.length; i++) user_selected_options[i] = 'empty'

    // saving current question number for next and previous
    // which is 0 initially
    var current_question_num = null
    function insert_question_and_options(question_num) {
        // if the question is first one then
        // disable the previous button and
        // vise-versa
        if (question_num+1 == questions.length) next_button.disabled = true
        else next_button.disabled = false
        if (question_num == 0) previous_button.disabled = true
        else previous_button.disabled = false

        // saving current question number
        current_question_num = question_num

        // the answers list
        const answers_list = document.getElementById('answers_list')
        // cleaing the options
        answers_list.innerHTML = ""

        // the question box
        const question = document.getElementById('question')
        // clearing the question
        question.innerHTML = ""

        question.innerText = questions[question_num].question

        for (var i=0; i<questions[question_num].options.length; i++){
            const option = document.createElement("li")
            option.className = "list-group-item"
            option_id = i
            option.id = option_id
            // option.onclick = "option_selected()"
            option.setAttribute('onclick','option_selected('+option_id+')')
            option.innerText = questions[question_num].options[i]
            answers_list.appendChild(option)  
        }

        // after creating the options
        // highlight the one previously set by the user
        if (user_selected_options[current_question_num] != null){
            const to_be_highlighted = document.getElementById(user_selected_options[current_question_num].option_id)
            to_be_highlighted.className = to_be_highlighted.className + ' active'
        }
    }

    // inserting the first question
    insert_question_and_options(0)
    // console.log(answers_list)

    // onclick for option selection
    // old selected_option
    var old_selected_option = null;
    function option_selected(option_id) {
        // unhighlighting the previously clicked option
        if (old_selected_option != null) {
            old_selected_option.className = 'list-group-item'
            old_selected_option.removeAttribute("style");
        }

        // unhighlighting the previously saved option
        if (user_selected_options[current_question_num] != null){
            const to_be_highlighted = document.getElementById(user_selected_options[current_question_num].option_id)
            to_be_highlighted.className = 'list-group-item'
        }

        const selected_option = document.getElementById(option_id)
        old_selected_option = selected_option
        selected_option.className = selected_option.className + ' active'
        selected_option.style.color = "black"
        
        // saving user selection
        const selected_option_innerText = selected_option.innerText
        user_selected_options[current_question_num] = {selected_option_innerText,option_id}
        console.log("current question : "+current_question_num)
        console.log("selected option : "+selected_option.innerText)
    }

    // next button
    function next() {
        console.log('next pressed')
        // if the last question is reached then alert it
        if (current_question_num+1 == questions.length) {
            alert("this is the last one")
            return
        }
        else{
            current_question_num++
            insert_question_and_options(current_question_num) 
        }
    }
    // previous button
    function previous() { 
        console.log('previous pressed')
        // if the first question is reached then alert it
        if (current_question_num == 0) {
            alert("this is the first one")
            return
        }
        else{
            current_question_num--
            insert_question_and_options(current_question_num) 
        }
    }

    const correct = '<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-check-circle" fill="green" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path fill-rule="evenodd" d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.236.236 0 0 1 .02-.022z"/></svg>'
    const wrong = '<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-x-circle-fill" fill="red" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-4.146-3.146a.5.5 0 0 0-.708-.708L8 7.293 4.854 4.146a.5.5 0 1 0-.708.708L7.293 8l-3.147 3.146a.5.5 0 0 0 .708.708L8 8.707l3.146 3.147a.5.5 0 0 0 .708-.708L8.707 8l3.147-3.146z"/></svg>'

    var score = 0
    function submit() {
        // clearing the time interval
        clearInterval(time_interval);

        // alert("you sure?")
        var number_of_correct_answers = 0
        var number_of_wrong_answers = 0
        var number_of_NA = 0
        for (var i=0; i<questions.length; i++){
            if (user_selected_options[i] != null && 
            questions[i].correct == user_selected_options[i].selected_option_innerText) {
                score++
                number_of_correct_answers++
            }
            else if (user_selected_options[i] != null && 
            questions[i].correct != user_selected_options[i].selected_option_innerText){
                score -= 0.33
                number_of_wrong_answers++
            }
            // un-attempted questions
            if (user_selected_options[i] == null) number_of_NA++
        }
        // alert(score)
        const modal_body = document.getElementById('modal-body')
        modal_body.innerHTML = ""
        var score_p = document.createElement('p')
        score_p.innerText = "SCORE : " + score.toFixed(2);
        modal_body.appendChild(score_p)
        // after appending score show details
        score_p = document.createElement('p')
        score_p.innerText = "CORRECT ANSWERS : " + number_of_correct_answers
        modal_body.appendChild(score_p)
        score_p = document.createElement('p')
        score_p.innerText = "WRONG ANSWERS : " + number_of_wrong_answers
        modal_body.appendChild(score_p)
        score_p = document.createElement('p')
        score_p.innerText = "NA : " + number_of_NA
        modal_body.appendChild(score_p)
        modal_body.appendChild(document.createElement('hr'))

        // display all the correct answers
        for (var i=0; i<questions.length; i++){
            var q = document.createElement('p')
            q.innerText = 'Q'+ (i+1) + ')  ' +questions[i].question
            modal_body.appendChild(q)
            var ca = document.createElement('p')
            
            if (user_selected_options[i] != null && questions[i].correct == user_selected_options[i].selected_option_innerText){
                ca.innerHTML = 'Ans'+ ')  ' + user_selected_options[i].selected_option_innerText + " " + correct
            }
            else if (user_selected_options[i] != null && questions[i].correct != user_selected_options[i].selected_option_innerText){
                ca.innerHTML = 'Ans'+ ')  ' + user_selected_options[i].selected_option_innerText + " " + wrong + "&nbsp;&nbsp;&nbsp;" + questions[i].correct + " " + correct
            }
            else ca.innerHTML = 'Ans'+ ')  ' + " NA &nbsp;&nbsp;&nbsp;" + questions[i].correct + " " + correct
            modal_body.appendChild(ca)
        }

        var pdf_path = "{{ pdf_path }}"
        // if pdf_path available
        if (pdf_path != null && pdf_path != ""){
            // to download complete explaination
            var pdf_viewer = document.createElement('a')
            pdf_viewer.href = pdf_path //'/pdf_uploads/vishnupart_1question_paper_1.pdf' //
            pdf_viewer.download = 'solutions'
            pdf_viewer.innerHTML = 'Download Complete Solution'
            modal_body.appendChild(pdf_viewer)
        }

        if (mode == 'test'){
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
            var yyyy = today.getFullYear();

            today = yyyy + '-' + mm + '-' + dd;
            const quiz_name = document.getElementById('heading').innerHTML
            const name = document.getElementById('name_of_user')

            // var minutes = parseInt(timeee / 60, 10)
            // var seconds = parseInt(timeee % 60, 10)
            // var total_time = parseFloat(minutes+'.'+seconds)
            // alert(total_time)
            var time_taken = timeee - current_time
            var minutes = parseInt(time_taken / 60, 10)
            var seconds = parseInt(time_taken % 60, 10)
            time_taken = parseFloat(minutes+'.'+seconds)
            // alert(time_taken)
            // return
            var data_to_send = {
                'name':name.value,
                'score':score.toFixed(2),
                'correct':number_of_correct_answers,
                'wrong':number_of_wrong_answers,
                'na':number_of_NA,
                'date':today,
                'quiz_name':quiz_name,
                'time_taken':time_taken
            }
            postData('/save_user_results', data_to_send)
            .then(data => {
                console.log(data); // JSON data parsed by `data.json()` call
            });
        }
    }

    // if test mode
    const mode = "{{mode}}"
    if (mode != 'test'){
        document.getElementById('user_details').hidden = true
        start_quiz()
    }

</script>

<style>
.list-group .list-group-item:hover {
    background-color:antiquewhite;
}
</style>